# Maids in Keel

## 概述

本包（`maids`）为 Keel 框架提供了在 **Vert.x 集群环境**下运行的服务模式实现。

> **重要说明**：由于集群节点之间传递数据的序列化实现特性，无法直接进行函数体传送，只能传送参数和执行体索引。

这些服务模式充分利用 Vert.x 的集群能力，包括：

- **EventBus**：用于节点间通信和负载均衡
- **SharedData**：用于分布式锁和共享状态管理
- **Verticle**：作为服务的基础运行单元

## 服务组件

### Gatling（加特林）

> 加特林多管机关枪 - 集群环境下的并行任务处理服务

**核心特性**：

- ✅ **集群支持**：通过 EventBus 实现负载均衡，任务在集群节点间自动分配
- ✅ **并行处理**：支持多管（多线程）并发执行任务，可配置并发数
- ✅ **自动任务加载**：使用共享锁机制确保任务只被一个节点加载和执行
- ✅ **独占锁机制**：支持任务级别的独占锁，避免任务冲突和重复执行
- ✅ **智能休眠**：无任务时自动休眠，减少资源消耗

**使用场景**：

- 批量数据处理任务
- 异步任务队列处理
- 需要并发执行但避免重复的任务

**工作原理**：

1. 每个 Gatling 实例在集群中运行，通过共享锁竞争任务加载权
2. 加载到任务后，检查任务的独占锁集合，确保不与其他任务冲突
3. 在配置的并发数（barrels）范围内并行执行任务
4. 任务执行完成后释放独占锁，继续加载下一个任务

---

### Watchman（更夫）

> 柝声 - 集群环境下的定时任务调度服务

**核心特性**：

- ✅ **集群支持**：通过 EventBus 实现负载均衡，定时任务随机在集群节点中执行
- ✅ **定时调度**：支持固定间隔的定时任务执行
- ✅ **Cron 支持**：支持 Cron 表达式的复杂调度规则
- ✅ **单节点执行**：使用分布式锁确保每个调度周期只有一个节点执行任务
- ✅ **时间同步**：自动对齐时间，确保调度精度

**使用场景**：

- 定时数据同步
- 定时报表生成
- 定时清理任务
- 定时健康检查

**工作原理**：

1. 每个 Watchman 实例在集群中运行，通过 EventBus 发送调度信号
2. 使用分布式锁机制，确保每个调度周期只有一个节点获得执行权
3. 获得锁的节点执行定时任务，其他节点自动跳过
4. 支持 Cron 表达式，实现复杂的调度规则

**实现类型**：

- `PureWatchman`：纯定时调度，固定间隔执行
- `CronWatchman`：基于 Cron 表达式的调度

---

### Pleiades（昴宿星团）

> 基于 Vert.x EventBus 的集群队列服务

**核心特性**：

- ✅ **集群队列**：基于 EventBus 实现的分布式消息队列
- ✅ **消息分发**：支持点对点和发布订阅模式
- ✅ **负载均衡**：消息自动在集群节点间负载均衡
- ✅ **类型安全**：支持泛型，确保消息类型安全

**使用场景**：

- 集群节点间的消息传递
- 事件驱动的任务分发
- 异步消息处理
- 微服务间通信

**工作原理**：

1. Pleiades 作为消息消费者，监听指定的 EventBus 地址
2. 通过 `generateMessageProducer` 创建消息生产者，向队列发送消息
3. 消息通过 EventBus 在集群中分发，自动负载均衡到各个节点
4. 每个节点上的 Pleiades 实例处理接收到的消息

---

## 集群体系下的协同工作

这三个服务组件可以在集群环境中协同工作，构建完整的分布式任务处理体系：

```
┌───────────────────────────────────────────────────────────┐
│            Vert.x Cluster Environment                     │
│                                                           │
│  ┌──────────────┐    ┌───────────────┐    ┌─────────────┐ │
│  │   Node A     │    │   Node B      │    │  Node C     │ │
│  │              │    │               │    │             │ │
│  │ ┌──────────┐ │    │ ┌──────────┐  │    │ ┌─────────┐ │ │
│  │ │ Gatling  │ │    │ │ Gatling  │  │    │ │Watchman │ │ │
│  │ │          │◄┼────┼─┤          │  │    │ │         │ │ │
│  │ │Parallel  │ │    │ │Parallel  │  │    │ │         │ │ │
│  │ │  Tasks   │ │    │ │  Tasks   │  │    │ │         │ │ │
│  │ └──────────┘ │    │ └──────────┘  │    │ └─────────┘ │ │
│  │              │    │               │    │             │ │
│  │ ┌──────────┐ │    │ ┌──────────┐  │    │ ┌─────────┐ │ │
│  │ │Pleiades  │◄┼────┼─┤Pleiades  │◄─┼────┼─│Pleiades │ │ │
│  │ │ Message  │ │    │ │ Message  │  │    │ │Message  │ │ │
│  │ │  Queue   │ │    │ │  Queue   │  │    │ │ Queue   │ │ │
│  │ └──────────┘ │    │ └──────────┘  │    │ └─────────┘ │ │
│  └──────────────┘    └───────────────┘    └─────────────┘ │
│         │                    │                  │         │
│         └────────────────────┼──────────────────┘         │
│                              │                            │
│                    EventBus + SharedData                  │
└───────────────────────────────────────────────────────────┘
```

**典型工作流程**：

1. **Watchman** 定时触发，通过 **Pleiades** 发送任务消息到队列
2. **Gatling** 从队列或数据源加载任务，在集群节点间并行处理
3. 所有服务通过 **SharedData** 的分布式锁机制协调，避免重复执行
4. 通过 **EventBus** 实现负载均衡和消息传递

---

## 注意事项

1. **序列化限制**：集群节点间传递的数据必须可序列化，函数体无法直接传递
2. **锁超时**：使用分布式锁时注意设置合理的超时时间，避免死锁
3. **节点一致性**：确保集群中所有节点的服务实现保持一致
4. **资源管理**：合理配置并发数和休眠间隔，避免资源浪费或过载
5. **错误处理**：实现完善的错误处理和日志记录，便于排查问题
